<!doctype html>
<html lang="en-US">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Breathing aid</title>

    <script type="text/ecmascript">

        var klikLoaded = false;
        var pageLoaded = false;
        var gotGoing = false;
            
        let startBtn,
            stopBtn,
            output;
        let maxBreathe = 12;    // Max number of seconds to inhale or exhale
        let minBreathe = 3;     // Min number of seconds to inhale or exhale

        // Get a sound file for our click sound
        let klik = new Audio("https://www.soundjay.com/buttons/button-15.wav")
        klik.addEventListener("canplaythrough", () => {
            if (pageLoaded)
                getGoing();
            klikLoaded = true;
        });
        document.addEventListener("DOMContentLoaded", () => {
            if (klikLoaded)
                getGoing();
            pageLoaded = true;
        });

        function getGoing() {
            if (gotGoing)
                return;
            gotGoing = true;
            startBtn = document.querySelector('#start');
            stopBtn = document.querySelector('#stop');
            output = document.querySelector('#output');
            output.textContent = "\xA0"
            next = document.querySelector('#next');

            startBtn.addEventListener('click', go);
            stopBtn.addEventListener('click', stopOutput);
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        let lastSeries = 0; // Unique number that identifies the current animation 
        const go = async () => {
            let thisSeries = ++lastSeries;
            var inhaling = true;
            let nextSeconds = randSeconds();
            //next.style.color = "red";
            next.textContent = "Next: in for " + nextSeconds;

            klik.play();
            await sleep(1000);

            while (thisSeries == lastSeries) {
                seconds = nextSeconds;
                nextSeconds = randSeconds();
                output.style.color = inhaling ? "red" : "blue";
                inhaling = !inhaling;
                for (let i = 1; i <= seconds && thisSeries == lastSeries; i++) {
                    output.textContent = i + " / " + seconds;
                    klik.play();
                    if (i == seconds) {
                        //next.style.color = inhaling ? "red" : "blue";
                        next.textContent = "Next: " + (inhaling ? "in" : "out") +
                            " for " + nextSeconds;
                    }
                    await sleep(1000);
                }
                next.textContent = "\xA0";
            }
        }

        const stopOutput = () => {
            ++lastSeries; // This will interrupt the animation.
            output.textContent = "\xA0"
        }

        //  Return a random integer between minBreathe and maxBreathe inclusive
        function randSeconds() {
            return Math.floor(Math.random() * (maxBreathe - minBreathe)) + 
                minBreathe;
        }

    </script>


    <style data-styled="" data-styled-version="4.4.1"></style>
</head>

<body>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
     <div>
        <div class="ms-3">
            <div class="mt-3 mx-auto">
                <button id="start" class="btn btn-sm btn-primary">Start</button>
                <button id="stop" class="btn btn-sm btn-info">Stop</button>
            </div>
            <div class="mt-3">
                <p id="next" style="font-size:small;"></p>
                <p id="output"></p>
            </div>
        </div>
    </div>

</body>
</html>
